<!DOCTYPE html>
<html>



<head>

    <!-- Microsoft Internet Explorer documentMode compatMode setting IE Modus --> 
    <script type="text/javascript">
    var IE = null;
    if (window.navigator.appName == "Microsoft Internet Explorer") {
      if (document.documentMode) {

        IE = document.documentMode; 
    } else {

        IE = 5; 
        if (document.compatMode) {
          if (document.compatMode == "CSS1Compat")
              IE = 11; 
      }
  }
}
</script>

<meta charset="utf-8">
<!-- X-UA --> 
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<!--<link rel="author" title="stillwater" href="https://plus.google.com/u/0/101869488504092117335/posts"/>
-->

<!--<meta name="google-site-verification" content="F5lkHug5Hdw4XRPcwJuQsK01auhET-yWy1o5SrCM-Sw" />
-->
<meta name="google" content="notranslate" />
<!-- Viewport --> 
<meta name="viewport" content="width=device-width, initial-scale=1">
<!-- index ROBOTS follow --> 
<meta name="robots"    content="index, follow" />
<!-- Site Desciption --> 
<meta name="description" content="Hello, My Name is stillwater, I'm a software Engineer and Web Developer from China. ">
<!-- Site Desciption --> 
<meta name="keywords" content="stillwater,victorylee, Web Developer, Front End Engineer">
<!-- Favicon --> 
<link rel="shortcut icon" href="/img/favicon-7326478236.png" type="image/x-icon" />
<!-- Blog Title -->
<title>stillwaterli - A software Engineer and Web Developer from China.  </title>

    <!--     <title>Velocity源码阅读(转) - stillwater</title>
--> 
<!-- Property Metas --> 
<meta property="og:image" content="/img/93TyTG3x.png"/>
<meta property="og:title" content="Hello, My Name is stillwater, I'm a software Engineer and Web Developer from China. "/>
<meta property="og:site_name" content="Hello, My Name is stillwater, I'm a software Engineer and Web Developer from China. "/>
<!-- Canonical -->
<link rel="canonical" href="http://localhost:4000/2016/11/10/Velocity%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB.html">
<!-- StyleSheet -->
<link rel="stylesheet" href="/css/pygments.css">
<link rel="stylesheet" href="/css/duoshuo.css">
<link rel="stylesheet" href="/css/bootstrap.min.css">

<link rel="stylesheet" href="/css/spaceg.stylesheets.css">
<!-- Fonts -->
<link href='https://fonts.googleapis.com/css?family=Merriweather:400,300,300italic,400italic,700,700italic,900,900italic' rel='stylesheet' type='text/css'>
<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
<link href='https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
<link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>
<link href='https://fonts.googleapis.com/css?family=Playfair+Display:400,700,900,400italic,700italic,900italic' rel='stylesheet' type='text/css'>
<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->
         <!-- <link href="https://gist-assets.github.com/assets/embed-b67021dc07195830cc157f7720b938fb.css" rel="stylesheet" type="text/css">-->

        <!-- Loading front stylesheet here --> 
        <style>

        .post-heading h1,.post-heading h2,.post-heading span{
            color:black !important;
        }
        .intro{
            margin: 50px;
            text-align: center;
        }
        .intro .post-heading h1{font-size:35px;}
        .intro .post-heading .subheading,.intro-header .post-heading .meta{line-height:1.1;display:block}
        .intro .post-heading .subheading{font-family:'Open Sans','Helvetica Neue',Helvetica,Arial,sans-serif;font-size:24px;margin:10px 0 30px;font-weight:400;color:white;}
        .intro .post-heading .meta{font-family:'Playfair Display', Times, serif;font-style:italic;font-weight:300;font-size:20px;color:white;}
        .intro .post-heading .meta a{color:#fff}
        @media only screen and (min-width: 768px){.intro .post-heading h1{font-size:55px}
        .intro .post-heading .subheading{font-size:30px;color:white;}}
        #preloader {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #fff;
            /* change if the mask should have another color then white */
            z-index: 99;
            /* makes sure it stays on top */
        }

        #status {
            width: 200px;
            height: 200px;
            position: absolute;
            left: 50%;
            /* centers the loading animation horizontally one the screen */
            top: 50%;
            /* centers the loading animation vertically one the screen */
            background-image: url("img/preloader.gif");
            /* path to your loading animation */
            background-repeat: no-repeat;
            background-position: center;
            margin: -100px 0 0 -100px;
            /* is width and height divided by two */
        }

        ul, ol {
            margin-top: 0;
            margin-bottom: 10px;
            list-style: none;
        }

        .navbar-inverse {
            background-color: #FFF;
            border-color: #FFFFFF;
        }
        </style>
        <link rel="stylesheet" href="/css/prettify.css">
        <style>header.intro-header {
            background: #6f5499;
            background: no-repeat center center;
            background-attachment: scroll;
            -webkit-background-size: cover;
            -moz-background-size: cover;
            background-size: cover;
            -o-background-size: cover;
            }/* Preloader */#preloader {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-color: #fff;
                /* change if the mask should have another color then white */
                z-index: 99;
                /* makes sure it stays on top */
            }

            #status {
                width: 200px;
                height: 200px;
                position: absolute;
                left: 50%;
                /* centers the loading animation horizontally one the screen */
                top: 50%;
                /* centers the loading animation vertically one the screen */
                background-image:;
                /* path to your loading animation */
                background-repeat: no-repeat;
                background-position: center;
                margin: -100px 0 0 -100px;
                /* is width and height divided by two */
            }

            li {
                list-style: none;
            }
            li 
            {list-style: none;}
            body.modal-open 
            {overflow: hidden;padding-right: 0px;
            }
            </style>
            <!-- end Loading front stylesheet here --> 
        </head>



<body>

	
<div id="preloader">
    <div id="status">

    </div>

</div>  

    
<!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
                <!--
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapses-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button> -->
            <a class="navbar-brand" href="/" id="blog-title-left-top">ME</a>
        </div>   
        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
              <li class="dropdown">
                <a href="#portfolioModal2" data-toggle="modal"><i class="fa fa-random" id="icon-top"></i></a>
                <ul class="dropdown-menu"></ul>
            </li>
            <li><a href="http://weibo.com/u/3948730723" target="_blank"><i class="fa fa-weibo" id="icon-top"></i></a></li>

            <li><a href="/about" target="_blank">About</a></li>
            <li><a href="/archive/">Archive</a></li>
            <li><a href="https://www.github.com/superstar4" id="roundbutton" target="_blank"><i class="fa fa-github"></i>stillwater</a></li>
        </ul>
    </div>
    <!-- /.navbar-collapse -->
</div>
<!-- /.container -->
</nav>
<!-- Portfolio Modals -->
<div class="portfolio-modal modal fade" id="portfolioModal1" tabindex="-1" role="dialog" aria-hidden="true" style="padding-right:0px; overflow: hidden;">
    <div class="modal-content">
        <div class="close-modal" data-dismiss="modal">
            <div class="lr">
                <div class="rl">
                </div>
            </div>
        </div>
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2">
                    <div class="modal-body">
                        <h1 class="font-style-inline-small-h1">stillwater</h1>
                        <hr class="star-primary">
                        <img src="/img/photo.jpg" class="img-responsive img-centered" alt="Lucas Gatsas lucas gatsas" title="lucas gatsas Lucas Gatsas">
                        <p class="font-style-inline-small">
                            Hello, My Name is stillwater, I'm a software Engineer and Web Developer from China.  <br>
                            <a href="https://www.github.com/superstar4" target="_blank">    <i class="fa fa-github" id="spaceg-social-modal"></i> </a> 
                            <a class="follow" href="https://plus.google.com/u/0/101869488504092117335/posts" target="_blank"><i class="fa fa-google-plus"></i></a>

                            <a class="follow" href="" target="_blank"><i class="fa fa-facebook"></i></a>

                            <a class="follow" href="http://weibo.com/u/3948730723" target="_blank"><i class="fa fa-weibo"></i></a> 
                        </p>
                        <button type="button" class="btn btn-default" data-dismiss="modal"><i class="fa fa-times"></i> Close</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Menu Modals Add New Sa.21.Feb.2015 03:22:25 -->
<div class="portfolio-modal modal fade" id="portfolioModal2" tabindex="-1" role="dialog" aria-hidden="true" style="padding-right:0px; overflow: hidden;">
    <div class="modal-content">
        <div class="close-modal" data-dismiss="modal">
            <div class="lr">
                <div class="rl">
                </div>
            </div>
        </div>
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2">
                    <div class="modal-body">
                        <h1 class="font-style-inline-small-h1">stillwater</h1>
                        <hr class="star-primary">
                        <!--     <img src="https://pbs.twimg.com/profile_images/598639420363923456/zLAW5YPs_400x400.jpg" class="img-responsive img-centered" alt=""> -->
                        <p class="font-style-inline-small">
                           <a href="https://www.github.com/superstar4" target="_blank">    <i class="fa fa-github" id="spaceg-social-modal"></i> </a> 
                            <a class="follow" href="https://plus.google.com/u/0/101869488504092117335/posts" target="_blank"><i class="fa fa-google-plus"></i></a>

                            <a class="follow" href="" target="_blank"><i class="fa fa-facebook"></i></a>

                            <a class="follow" href="http://weibo.com/u/3948730723" target="_blank"><i class="fa fa-weibo"></i></a> 
                        
                             <br>
                            <li><a href="/">Home</a></li>
                            <li><a href="/about">About Me</a></li>
                            <li><a href="/archive/">Archive</a></li>
                        </p>

                        <button type="button" class="btn btn-default" data-dismiss="modal"><i class="fa fa-times"></i> Close</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



    <!-- Post Header -->
 
    <header class="intro">

    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <h1>Velocity源码阅读(转)</h1>
                    
                    <span class="meta">Posted by stillwater  </span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">

				<blockquote>
  <p>Velocity 是一个基于Java的模板引擎。它高效、简洁，且有很好的可扩展性，适合在Web项目中做为MVC模型中的视图，也可以在内容生成、数据转换等应用中独立使用。本文将以源码阅读的方式，浅析velocity的实现机制，并通过几个小例子来阐述velocity中主要使用的技术点。</p>
</blockquote>

<!-- more -->

<h3 id="1下载源码">1.下载源码</h3>

<p>Velocity是Apache的顶级项目。可以从 http://velocity.apache.org/ 上获取最新源码，最新版本是1.7。为了契合日常的工作，这里使用1.6.3版本做为本文基准版本，可以从 http://archive.apache.org/dist/velocity/engine/ 获取Older releases版本。</p>

<p>下载：http://archive.apache.org/dist/velocity/engine/1.6.3/velocity-1.6.3.tar.gz</p>

<p>原始的velocity使用ant构建工程，如果要使用maven可以单独下载对应的pom文件，重命名后放入工程目录。 http://archive.apache.org/dist/velocity/engine/1.6.3/velocity-1.6.3.pom</p>

<p>下载完成后，解压，放入pom.xml，然后 <code class="highlighter-rouge">mvn eclipse:eclipse -DdownloadSources=true</code>，可以愉快的看源码了~</p>

<h3 id="2代码结构">2.代码结构</h3>

<p>看代码前，先来了解一下velocity的工程目录结构：</p>

<table>
  <thead>
    <tr>
      <th>目录</th>
      <th>说明</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>build/</td>
      <td>存放一些ant构建脚本，比如可以使用<code class="highlighter-rouge">ant javadocs</code>生成javadoc</td>
    </tr>
    <tr>
      <td>convert/</td>
      <td>WebMacro到Velocity的转换程序，WebMacro是老牌模板引擎，Velocity脱胎于它，参见 http://velocity.apache.org/engine/releases/velocity-1.4/differences.html 了解它们的不同。</td>
    </tr>
    <tr>
      <td>docs/</td>
      <td>Velocity开发文档，快速指南等</td>
    </tr>
    <tr>
      <td>docs/api/</td>
      <td>Velocity Javadocs</td>
    </tr>
    <tr>
      <td>examples/</td>
      <td>如何使用Velocity的几个例子</td>
    </tr>
    <tr>
      <td>lib/</td>
      <td>velocity依赖的包</td>
    </tr>
    <tr>
      <td>lib/test/</td>
      <td>单元测试依赖的包</td>
    </tr>
    <tr>
      <td>src/</td>
      <td>源码包</td>
    </tr>
    <tr>
      <td>test/</td>
      <td>单测</td>
    </tr>
    <tr>
      <td>xdocs/</td>
      <td>从xml构建docs站点的源文件</td>
    </tr>
    <tr>
      <td>LICENSE</td>
      <td>Apache License Version 2.0 ，可作为开源或商业软件再发布</td>
    </tr>
    <tr>
      <td>velocity-1.6.3.jar</td>
      <td>velocity jar</td>
    </tr>
    <tr>
      <td>velocity-1.6.3-dep.jar</td>
      <td>velocity 将依赖打入的standalone jar</td>
    </tr>
  </tbody>
</table>

<h4 id="21hello-world-">2.1.Hello World !</h4>

<blockquote>
  <p>在开始Hello World前，可以思考一下，如果是自己来设计一个模板引擎需要哪些步骤？</p>

  <p>嗯，应该需要一个上下文变量Context，用于存放一些会渲染到模板中的变量；然后通过文件或是常量字符串来获取模板；模板里面掏几个占位符，用一些特殊的标记隔离出来(比如#name#)；最后解析模板中的占位符，将Context中的变量的实际值替换进去，然后输出merge后的结果完成模板渲染。(之前自定义短信模板这么做的，很轻巧；邮件内容较多，则使用velocity。)</p>
</blockquote>

<p>思考过后，我们来run一个examples目录下的例子，找到应用程序的入口点，然后进行代码阅读，看看跟我们想的是否一样。 将examples/下的第一个例子app_example1/的样例文件(主要是Example.java、example.vm、velocity.properties)copy到src里。</p>

<p>Example</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Example</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="nf">Example</span><span class="o">(</span><span class="n">String</span> <span class="n">templateFile</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="cm">/*
             * Velocity的初始化可以使用Velocity类通过RuntimeSingleton类的单例模式初始化，或者使用
             * VelocityEngine类创建并初始化。两者用在不同的场景。
             */</span>
            <span class="n">Velocity</span><span class="o">.</span><span class="na">init</span><span class="o">(</span><span class="s">"velocity.properties"</span><span class="o">);</span>

            <span class="cm">/*
             * 构建模板上下文，放入一些将会渲染的变量。
             */</span>
            <span class="n">VelocityContext</span> <span class="n">context</span> <span class="o">=</span> <span class="k">new</span> <span class="n">VelocityContext</span><span class="o">();</span>
            <span class="n">context</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"list"</span><span class="o">,</span> <span class="n">getNames</span><span class="o">());</span>

            <span class="cm">/*
             * 从文件获取模板：此过程会在调用Template.process()过程中生成抽象语法树AST。这个貌似比想象的要复杂一点，
             * 稍后来讨论AST相关内容。
             */</span>
            <span class="n">Template</span> <span class="n">template</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">template</span> <span class="o">=</span> <span class="n">Velocity</span><span class="o">.</span><span class="na">getTemplate</span><span class="o">(</span><span class="n">templateFile</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">ResourceNotFoundException</span> <span class="n">rnfe</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Example : error : cannot find template "</span>
                        <span class="o">+</span> <span class="n">templateFile</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">ParseErrorException</span> <span class="n">pee</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Example : Syntax error in template "</span>
                        <span class="o">+</span> <span class="n">templateFile</span> <span class="o">+</span> <span class="s">":"</span> <span class="o">+</span> <span class="n">pee</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="cm">/*
             * 模板执行merge动作，将context的变量替换到template中，此过程使用到java的Introspection机制，实现了一套反射功能。
             */</span>
            <span class="n">BufferedWriter</span> <span class="n">writer</span> <span class="o">=</span> <span class="n">writer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BufferedWriter</span><span class="o">(</span>
                    <span class="k">new</span> <span class="nf">OutputStreamWriter</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">));</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">template</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                <span class="n">template</span><span class="o">.</span><span class="na">merge</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">writer</span><span class="o">);</span>

            <span class="cm">/*
             * flush and cleanup，放finally比较好，虽然只是测试代码
             */</span>
            <span class="n">writer</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
            <span class="n">writer</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="o">}</span> 
        <span class="o">...</span>
    <span class="o">}</span>

    <span class="o">...</span>
<span class="o">}</span>
</code></pre>
</div>

<p>通过阅读和执行Example例子，我们看到velocity运转时的几个关键步骤：</p>

<p>1.引擎初始化。</p>

<p>2.获取模板文件并解析生成AST。</p>

<p>3.构建context并将其merge到模板中输出。</p>

<p>接下来将就这三个重要步骤做进一步的阅读和分析。</p>

<h3 id="3初始化过程">3.初始化过程</h3>

<p>RuntimeInstance.init()</p>

<div class="highlighter-rouge"><pre class="highlight"><code>public synchronized void init() throws Exception {
        ...
                // 初始化配置，先读org/apache/velocity/runtime/defaults/velocity.properties，然后再合并应用特殊配置。
                initializeProperties();

                // 初始化日志，可通过properties文件配置使用何种日志组件。
                initializeLog();

                // 初始化资源管理类，对模板资源的管理、缓存等。
                initializeResourceManager();

                // 初始化velocity指令配置：org/apache/velocity/runtime/defaults/directive.properties。加载8个预定义指令，比如Foreach，以及userdirective配置的用户指令。
                initializeDirectives();

                // 初始化5种事件处理器，包括空值处理、异常处理等。详见org.apache.velocity.app.event包。
                initializeEventHandlers();

                // 初始化解析器池。
                initializeParserPool();

                // 初始化反射处理类。
                initializeIntrospection();

                // 初始化宏工厂，我们日常使用的macros.vm。
                vmFactory.initVelocimacro();
        ...
    }

</code></pre>
</div>

<p>初始化过程涉及到比较多的点，本文将不展开分析，着重分析其中两个点：解析器和反射，也正是关键的运行步骤中的2、3。</p>

<h3 id="4抽象语法树ast">4.抽象语法树AST</h3>

<p>Velocity是通过JavaCC和JJTree生成抽象语法树的。说到JavaCC我们先来了解它相关的几个概念。</p>

<blockquote>
  <p>BNF – 复杂语言的语法通常都是使用 BNF（巴科斯-诺尔范式，Backus-Naur Form）表示法或者其“近亲”― EBNF（扩展的 BNF）描述的。</p>
</blockquote>

<div class="highlighter-rouge"><pre class="highlight"><code>BNF 规定是推导规则(产生式)的集合，写为：
&lt;符号&gt; ::= &lt;使用符号的表达式&gt;

这里的 &lt;符号&gt; 是非终结符，而表达式由一个符号序列，或用指示选择的竖杠 '|' 分隔的多个符号序列构成，每个符号序列整体都是左端的符号的一种可能的替代。从未在左端出现的符号叫做终结符。

</code></pre>
</div>

<blockquote>
  <p>JavaCC 是一个用于生成解析器的工具，它可以将一份语法定义（以.jj为后缀的文件）转化成Java代码用于检查一本文本是否符合这一份语法定义。</p>

  <p>JJTree 是JavaCC提供的一个工具，JJTree可以将一份语法定义（以.jjt为后缀的文件，语法和.jj文件基本相同）转化成Java 代码，这段代码可以检查一份输入是否符合这一份语法定义。并且最后还会生成一颗抽象语法树提供给使用者来遍历。Velocity就将其模板语法定义成了一个jjt文件，然后根据这一份jjt文件生成了velocity模板的解析器。</p>
</blockquote>

<h4 id="41javacc-examples">4.1.JavaCC Examples</h4>

<p>简单了解了JavaCC的相关概念之后，我们来看JavaCC自带的例子如何构建一个AST。</p>

<p>从http://javacc.java.net/下载JavaCC工具(内含JJTree工具)。本文使用5.0版本。</p>

<p>解压后，进入到javacc-5.0/examples/SimpleExamples目录，先看一个纯JavaCC的简单例子。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>// 参数配置段：Simple1中列举了JavaCC配置的默认值。
options {
  ... 
}

// 解析器段：这里可以编写任意Java代码，只要保证PARSER_BEGIN、PARSER_END的参数与Java类名一致。
PARSER_BEGIN(Simple1)

/** Simple brace matcher. */
public class Simple1 {

  /** Main entry point. */
  public static void main(String args[]) throws ParseException {
    Simple1 parser = new Simple1(System.in);
    parser.Input();
  }

}

PARSER_END(Simple1)

// 产生式段
/** Root production. */
void Input() :
{}
{
  MatchedBraces() ("\n"|"\r")* &lt;EOF&gt;
}

/** Brace matching production. */
void MatchedBraces() :
{}
{
  "{" [ MatchedBraces() ] "}"
}
</code></pre>
</div>

<p>如上一个jj文件包含几个段落的代码，参数配置、解析器、产生式，常用的还有SKIP(跳词)、TOKEN(关键字)等，更多可参见 https://javacc.java.net/doc/javaccgrm.html。</p>

<p>正如上面介绍的BNF范式，jj文件中的产生式即是遵循它来实现，只是语法上更贴近Java的方法； 冒号左侧的”符号”即是方法名，冒号右侧的”使用符号的表达式”分为两部分：第一个{}是声明，用于声明变量和一些初始化的动作，如果没有可以忽略，使用方式参见Simple3例子；第二个{}是语法部分和动作部分，语法部分表示左侧可被替换的项，动作部分参见Simple3例子，可以是返回值或者一组动作。</p>

<p>Simple1的Input方法的语法部分 <code class="highlighter-rouge">MatchedBraces() ("\n"|"\r")*</code> 的含义是：可被MatchedBraces这个产生式替代，随后可有任意个回车换行符号，最后以文件结束符结尾(是javacc系统定义的TOKEN，表示文件结束符号)。</p>

<p>MatchedBraces方法的语法部分 <code class="highlighter-rouge">"{" [ MatchedBraces() ] "}"</code> 的含义是：一个以{开始，并配对的以}结束的串，期间可以有任意个递归的MatchedBraces方法。</p>

<p>这份解析器可以解析如 <code class="highlighter-rouge">"{ }", "{ { { { { } } } } }"</code> 这样的串； 不能解析 <code class="highlighter-rouge">"{ { { {", "{ } { }", "{ } }", "{ { } { } }", "{ }", "{x}"</code> 这样的串。</p>

<h4 id="42jjtree-examples">4.2.JJTree Examples</h4>

<p>接下来，我们通过编译运行的方式看一个结合了JJTree的例子。 进入到javacc-5.0/examples/JJTreeExamples目录，先来手工编译一把eg1.jjt。(本身例子自带ant编译文件，这里了解下编译过程)。</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="n">jjtree</span> <span class="n">eg1</span><span class="o">.</span><span class="na">jjt</span> <span class="c1">// 生成Node文件及jj文件</span>
<span class="n">javacc</span> <span class="n">eg1</span><span class="o">.</span><span class="na">jj</span> <span class="c1">// 生成Eg1.java及相关解析文件</span>
<span class="n">javac</span> <span class="o">*.</span><span class="na">java</span> <span class="c1">// 编译Java源文件</span>

<span class="n">java</span> <span class="n">Eg1</span> <span class="c1">// 运行例子，输入待解析的文本</span>
<span class="mi">1</span><span class="o">+</span><span class="mi">1</span><span class="o">;</span> <span class="c1">// 回车生成一个AST</span>

<span class="n">Start</span>
 <span class="n">Expression</span>
  <span class="n">AdditiveExpression</span>
   <span class="n">MultiplicativeExpression</span>
    <span class="n">UnaryExpression</span>
     <span class="n">Integer</span>
   <span class="n">MultiplicativeExpression</span>
    <span class="n">UnaryExpression</span>
     <span class="n">Integer</span>
</code></pre>
</div>

<p>eg1例子实现了4则运算，先乘除后加减，如果有括号则先解析括号中的。如上如果是一个简单加法运算，它生成的AST将会包含空节点：MultiplicativeExpression(乘除)、UnaryExpression(括号)，除此之外就是一颗树了。大家可以输入更为复杂的4则运算表达式以观察生成的树的构成。</p>

<p>例子中通过SimpleNode的dump方法输出了Tree。SimpleNode是JJTree中表示一个节点的父类。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>SimpleNode n = t.Start();
n.dump("");

...

/** Main production. */
SimpleNode Start() : {}
{
  Expression() ";"
  { return jjtThis; }
}

</code></pre>
</div>

<h4 id="42从源码构建velocity的解析器">4.2.从源码构建Velocity的解析器</h4>

<p>看完上面的JJTree的简单例子我们就大体上清楚velocity解析器的构建方式。velocity的解析器需要JavaCC 3.2版本以上。</p>

<p>velocity的jjt文件在src/parser/Parser.jjt，产生的jj文件及其他生成的文件在org.apache.velocity.runtime.parser包下。在其子包node下，有jjt文件生成的一组继承自SimpleNode的节点。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>jjtree Parser.jjt // 生成Parser.jj、一组Node的Java文件骨架(需要自行实现Node的功能性代码)等
javacc Parser.jj // 生成解析器

</code></pre>
</div>

<p>最终生成的解析器会在Template.process()方法中调用。 要想完整的理解Parser.jjt文件，还需要进一步阅读javacc-5.0/doc/JJTree.html文档，了解jjtree相关的扩展语法。</p>

<h3 id="5模板渲染">5.模板渲染</h3>

<p>velocity中为了将context中的复杂对象merge到模板中渲染呈现，实现了一套自省机制。可以通过Enterprise Architect来对org.apache.velocity.util.introspection包下的代码做逆向工程，生成UML图以便阅读代码结构。如下图是去除枝节后的类图结构：</p>

<p><img src="http://xiongzheng.me/postimg/velocity1.jpg" alt="image" />
​                                         图1 velocity自省类图</p>

<p>通过类图我们来梳理一下其中的关系。 Uberspect是主要的自省/反射接口，提供方法如下：</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="n">init</span><span class="o">()</span><span class="err">：初始化</span>
<span class="n">getIterator</span><span class="o">()</span><span class="err">：支持迭代</span> <span class="err">#</span><span class="n">foreach</span>
<span class="nf">getMethod</span><span class="o">()</span><span class="err">：支持方法调用</span> <span class="n">$foo</span><span class="o">.</span><span class="na">bar</span><span class="o">(</span> <span class="n">$woogie</span> <span class="o">)</span>
<span class="n">getPropertyGet</span><span class="o">()</span><span class="err">：支持获取属性值</span> <span class="n">$bar</span><span class="o">.</span><span class="na">woogie</span>
<span class="n">getPropertySet</span><span class="o">()</span><span class="err">：支持设置属性值</span> <span class="err">#</span><span class="n">set</span><span class="o">(</span><span class="n">$foo</span><span class="o">.</span><span class="na">bar</span> <span class="o">=</span> <span class="s">"geir"</span><span class="o">)</span>
</code></pre>
</div>

<p>Uberspect的实现UberspectImpl，该实现使用Introspector完成自省功能。Introspector扩展自基类IntrospectorBase，增添日志记录。 IntrospectorBase内部维护了一个IntrospectCache，用于缓存已经完成自省的类和方法信息。 IntrospectorCacheImpl内通过一个HashMap维护一个class与其对应的类型信息，类型信息用一个ClassMap表示。 一个ClassMap内部维护了一个MethodCache，用于缓存该类已经解析出得方法信息。MethodMap表示一个方法信息。</p>

<p>了解完类图之后，我们来看一个例子，通过这个例子可以更好的理解模板渲染过程。</p>

<h4 id="51velocity的ast">5.1.velocity的AST</h4>

<p>在org.apache.velocity.runtime.parser包下找到Parser.java(本类即上面通过jjtree&amp;javacc构建的解析器入口文件)。 给Parser.java类加个main方法，以便将解析生成的AST dump输出出来。</p>

<div class="highlighter-rouge"><pre class="highlight"><code>public static void main(String[] args) {
    String temp = "我是一名来自$company的$person.business('short'),我叫$person.name";
    CharStream stream = new VelocityCharStream(new ByteArrayInputStream(temp.getBytes()), 0, 0);
    Parser t = new Parser(stream);
    try {
        SimpleNode n = t.process();
        n.dump("");
    } catch (Exception e) {
        e.printStackTrace();
    }
}

</code></pre>
</div>

<p>输出的AST：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>*.node.ASTprocess@68a75974[id=0,info=0,invalid=false,children=6,tokens=[我是一名来自],    [$company], [的],  [$person],  [.],    [business], [(],    ['short'],  [)],    [,我叫],  [$person],  [.],    [name], [e]]
    *.node.ASTText@42e20459[id=19,info=0,invalid=false,children=0,tokens=[我是一名来自]]
    *.node.ASTReference@48b915d[id=16,info=0,invalid=false,children=0,tokens=[$company]]
    *.node.ASTText@66f472ff[id=19,info=0,invalid=false,children=0,tokens=[的]]
    *.node.ASTReference@3aa9f827[id=16,info=0,invalid=false,children=1,tokens=[$person],    [.],    [business], [(],    ['short'],  [)]]
        *.node.ASTMethod@6ce2e687[id=15,info=0,invalid=false,children=2,tokens=[business],  [(],    ['short'],  [)]]
            *.node.ASTIdentifier@248ce0ea[id=8,info=0,invalid=false,children=0,tokens=[business]]
            *.node.ASTStringLiteral@1d023565[id=7,info=0,invalid=false,children=0,tokens=['short']]
    *.node.ASTText@7bff88c3[id=19,info=0,invalid=false,children=0,tokens=[,我叫]]
    *.node.ASTReference@456bf9ce[id=16,info=0,invalid=false,children=1,tokens=[$person],    [.],    [name]]
        *.node.ASTIdentifier@33dd66fd[id=8,info=0,invalid=false,children=0,tokens=[name]]

</code></pre>
</div>

<p>可以看到，temp模板中的纯文本被解析为ASTText节点，变量被解析为ASTReference节点，如果是方法则被解析为ASTMethod(方法参数解析为各种类型节点，比如ASTStringLiteral)，如果是属性解析为ASTIdentifier。</p>

<h4 id="52merge过程">5.2.merge过程</h4>

<p>Template.merge方法中调用了AST的根节点(ASTprocess)的render方法 <code class="highlighter-rouge">( (SimpleNode) data ).render( ica, writer);</code> 。此调用将迭代处理各个子节点render方法。如果是ASTReference类型的节点则在render方法中会调用execute方法执行反射替换相关处理。</p>

<p>以ASTMethod为例，来看一下execute方法的反射过程。</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ASTMethod</span> <span class="kd">extends</span> <span class="n">SimpleNode</span> <span class="o">{</span>

<span class="kd">public</span> <span class="n">Object</span> <span class="nf">execute</span><span class="o">(</span><span class="n">Object</span> <span class="n">o</span><span class="o">,</span> <span class="n">InternalContextAdapter</span> <span class="n">context</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">MethodInvocationException</span>
    <span class="o">{</span>
        <span class="c1">// 获取方法</span>
        <span class="n">VelMethod</span> <span class="n">method</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

        <span class="n">Object</span> <span class="o">[]</span> <span class="n">params</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Object</span><span class="o">[</span><span class="n">paramCount</span><span class="o">];</span>

        <span class="k">try</span>
        <span class="o">{</span>
            <span class="c1">// 获得参数类型</span>
            <span class="kd">final</span> <span class="n">Class</span><span class="o">[]</span> <span class="n">paramClasses</span> <span class="o">=</span> <span class="n">paramCount</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="k">new</span> <span class="n">Class</span><span class="o">[</span><span class="n">paramCount</span><span class="o">]</span> <span class="o">:</span> <span class="n">ArrayUtils</span><span class="o">.</span><span class="na">EMPTY_CLASS_ARRAY</span><span class="o">;</span>

            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">paramCount</span><span class="o">;</span> <span class="n">j</span><span class="o">++)</span>
            <span class="o">{</span>
                <span class="n">params</span><span class="o">[</span><span class="n">j</span><span class="o">]</span> <span class="o">=</span> <span class="n">jjtGetChild</span><span class="o">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="o">).</span><span class="na">value</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>

                <span class="k">if</span> <span class="o">(</span><span class="n">params</span><span class="o">[</span><span class="n">j</span><span class="o">]</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                <span class="o">{</span>
                    <span class="n">paramClasses</span><span class="o">[</span><span class="n">j</span><span class="o">]</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="n">j</span><span class="o">].</span><span class="na">getClass</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>

            <span class="c1">// 尝试从缓存中获取方法</span>
            <span class="n">MethodCacheKey</span> <span class="n">mck</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MethodCacheKey</span><span class="o">(</span><span class="n">methodName</span><span class="o">,</span> <span class="n">paramClasses</span><span class="o">);</span>
            <span class="n">IntrospectionCacheData</span> <span class="n">icd</span> <span class="o">=</span>  <span class="n">context</span><span class="o">.</span><span class="na">icacheGet</span><span class="o">(</span> <span class="n">mck</span> <span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span> <span class="n">icd</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">o</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">icd</span><span class="o">.</span><span class="na">contextData</span> <span class="o">==</span> <span class="n">o</span><span class="o">.</span><span class="na">getClass</span><span class="o">())</span> <span class="o">)</span>
            <span class="o">{</span>
                <span class="n">method</span> <span class="o">=</span> <span class="o">(</span><span class="n">VelMethod</span><span class="o">)</span> <span class="n">icd</span><span class="o">.</span><span class="na">thingy</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="k">else</span>
            <span class="o">{</span>
                <span class="c1">// 缓存获取不到则使用自省机制获取，并写入缓存</span>
                <span class="n">method</span> <span class="o">=</span> <span class="n">rsvc</span><span class="o">.</span><span class="na">getUberspect</span><span class="o">().</span><span class="na">getMethod</span><span class="o">(</span><span class="n">o</span><span class="o">,</span> <span class="n">methodName</span><span class="o">,</span> <span class="n">params</span><span class="o">,</span> <span class="k">new</span> <span class="n">Info</span><span class="o">(</span><span class="n">getTemplateName</span><span class="o">(),</span> <span class="n">getLine</span><span class="o">(),</span> <span class="n">getColumn</span><span class="o">()));</span>

                <span class="k">if</span> <span class="o">((</span><span class="n">method</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">o</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">))</span>
                <span class="o">{</span>
                    <span class="n">icd</span> <span class="o">=</span> <span class="k">new</span> <span class="n">IntrospectionCacheData</span><span class="o">();</span>
                    <span class="n">icd</span><span class="o">.</span><span class="na">contextData</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="na">getClass</span><span class="o">();</span>
                    <span class="n">icd</span><span class="o">.</span><span class="na">thingy</span> <span class="o">=</span> <span class="n">method</span><span class="o">;</span>

                    <span class="n">context</span><span class="o">.</span><span class="na">icachePut</span><span class="o">(</span> <span class="n">mck</span><span class="o">,</span> <span class="n">icd</span> <span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="o">...</span>
        <span class="o">}</span>
        <span class="o">...</span>

        <span class="k">try</span>
        <span class="o">{</span>
            <span class="c1">// 通过反射调用方法，获得返回值</span>
            <span class="n">Object</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">o</span><span class="o">,</span> <span class="n">params</span><span class="o">);</span>

            <span class="k">if</span> <span class="o">(</span><span class="n">obj</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
            <span class="o">{</span>
                <span class="k">if</span><span class="o">(</span> <span class="n">method</span><span class="o">.</span><span class="na">getReturnType</span><span class="o">()</span> <span class="o">==</span> <span class="n">Void</span><span class="o">.</span><span class="na">TYPE</span><span class="o">)</span>
                <span class="o">{</span>
                    <span class="k">return</span> <span class="s">""</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>

            <span class="k">return</span> <span class="n">obj</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="o">...</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<p>ASTMethod的主要执行过程：首先从IntrospectionCache中获取方法，如果没有缓存过，则通过Uberspect反射出方法，并执行方法返回结果。 最终每个节点返回的结果会拼接成文本渲染输出。</p>

<h3 id="6小结">6.小结</h3>

<p>本文通过源码阅读、样例分析的方式，介绍了velocity如何使用Java提供的JavaCC、JJTree和自省工具达到模板渲染的目的。其中使用的工具和方法希望对读者在其他源码分析过程中有所帮助。</p>

<p>Java为了能够实现动态语言原生就支持的特性比如：反射、闭包等，需要做很多事情，弄的很复杂的样子；在某些场景下，更适合用动态语言来弥补Java的短板，比如模板、DSL等都可以通过在Java中方便的集成Groovy等脚本语言来支持。</p>



                <hr>


<div id="ds-thread" class="ds-thread" data-url="/2016/11/10/Velocity%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB.html" data-title="Velocity源码阅读(转)" data-thread-key="Velocity源码阅读(转)"></div>
<script type="text/javascript">
var duoshuoQuery = {short_name: "stillwater"};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = 'http://static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ds);
})();
</script>

                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/2016/10/12/AWK%E5%91%BD%E4%BB%A4.html" data-toggle="tooltip" data-placement="top" title="AWK命令">&larr; Previous Post</a>
                    </li>
                    
                    
                </ul>

            </div>
        </div>
    </div>
</article>
<hr>



    <!-- Footer -->
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center">
          <li>
            <a href="/feed.xml" data-datatype="json" data-type="GET" data-target="#frame" class="reload" id="clickme">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
          
          <li>
            <a href="" data-datatype="json" data-type="GET" data-target="#frame" class="reload" id="clickme" target="_blank">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-google-plus fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
          
          <li>
            <a href="https://github.com/superstar4" target="_blank">
              <span class="fa-stack fa-lg">

                <i class="fa fa-arrow-circle-o-down"></i>
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
          
          <li>
            <a href="http://weibo.com/u/3948730723" target="_blank">
              <span class="fa-stack fa-lg">

                <i class="fa fa-arrow-circle-o-down"></i>
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-weibo fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
          
        </ul>
        <p class="copyright text-muted">Copyright &copy; stillwater 2017 - 2016.
        </p>
      </div>
    </div>
  </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js "></script>

<script src="/js/spaceg.stylesheets.min.js"></script> 

<script src="/js/bootstrap.min.js "></script>




<script type="text/javascript">
  //<![CDATA[
    $(window).load(function() { // makes sure the whole site is loaded
      $('#status').fadeOut(); // will first fade out the loading animation
      $('#preloader').delay(150).fadeOut('fast'); // will fade out the white DIV that covers the website.
      $('body').delay(100).css({'overflow':'visible'});
    })
  //]]>
  </script> 

  <script>
  !function ($) {
    $(function(){
      window.prettyPrint && prettyPrint()
    })
  }(window.jQuery)
  </script>


  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-53988504-1', 'auto');
  ga('send', 'pageview');

  </script> 
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-63212709-1', 'auto');
  ga('send', 'pageview');

  </script>
<script>
$(function(){
    $('pre code').each(function(){
        var lines = $(this).text().split('\n').length-1;
        var $numbering = $('<ul/>').addClass('pre-numbering');
        $(this)
            .addClass('has-numbering')
            .parent()
            .append($numbering);
        for(i=1;i<=lines;i++){
            $numbering.append($('<li><span></span></li>').text(i));
        }
    });
});

</script>


    

</body>

</html>
